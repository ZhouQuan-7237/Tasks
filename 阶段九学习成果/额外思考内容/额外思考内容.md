# 额外思考内容——周全

### 1.不使用 nginx 能不能正常部署后端服务呢？

#### 能正常部署。

比如，在我的 mms 项目文件中，Gin 框架能够处理路由和 HTTP 请求，

所以我们可以使用 Gin 框架来启动后端服务，监听8080端口处理请求，

便可完成后端服务的简单部署。

这样，客户端通过 `http://192.168.220.129:8080`便可访问后端服务。



#### 为什么这样可行？

Gin 是基于 Go 语言的高性能 HTTP 框架,内置HTTP 服务器，

当使用 `router.Run(":8080")` 启动时， Gin 框架会监听 8080 端口，

处理所有发送到该端口的 HTTP 请求。

当客户端访问 `http://192.168.220.129:8080` 时：

1. 请求到达服务器的 8080 端口。
2. Gin 解析 HTTP 协议，匹配路由并执行相应的逻辑。
3. 生成响应，并通过同一 TCP 连接返回客户端。

通过这种方式，如果客户端能够正常与后端服务交互，说明后端服务部署成功。



#### 使用 Gin 内置服务器部署后端服务所有接口操作步骤

1. 打开Linux虚拟机

2. 进入项目目录`cd ~/go/mms`

3. 启动Gin服务器`go run main.go`

4. curl访问接口验证部署(步骤与nginx部署相同)

   

### 2.如果可以的话为啥要用 nginx（有啥优势）？

与Gin内置服务器相比，nginx具有以下优点：

**(1) 支持高并发连接**：Nginx 并发连接能力更强，适用于大流量网站和高并发场景。

**(2) 低内存消耗**：Nginx 的内存占用少，启动速度快，非常适合处理大量并发请求。

**(3) 提供反向代理和负载均衡功能**：Nginx 不仅可以作为反向代理服务器，还能实现负载均衡，有效分配流量，提升系统的可扩展性和稳定性。

<<<<<<< HEAD


=======
>>>>>>> 320f58e284438d4977c762ab84964cee392f07c7
### 3. 能否通过实验数据证明？

#### 答案：可以

#### 3.1 实验目标

比较 Gin 内置服务器部署后端接口与 Nginx 部署后端接口的并发连接能力和内存消耗占比

#### 3.2 实验工具
- **wrk**：压力测试，观察 QPS（每秒查询数）、平均延迟、错误量等指标
- **htop**：实时监控内存和 CPU 使用情况
- **nmon**：记录历史数据。
- **nmon analyzer**：分析 nmon 数据，计算内存消耗占比

#### 3.3 实验准备
1. **安装 htop**：
   ```bash
   sudo apt install htop
   ```
2. **安装 nmon**：
   ```bash
   sudo apt install nmon
   ```
3. **安装 wrk**：
   ```bash
   sudo apt install wrk
   ```

#### 3.4 实验思路
**1）并发连接能力测试**：

- 使用 `wrk` 对 Gin 内置服务器和 Nginx 部署的后端接口分别进行压力测试。
- 记录 QPS（每秒查询数）、平均延迟和错误量等指标，比较两者的并发连接能力。

**2）内存消耗测试**：

- 使用 `htop` 和 `nmon` 在压力测试期间实时监控内存和 CPU 使用情况。
- 使用 `nmon analyzer` 分析 nmon 数据，计算内存消耗占比，比较两者的内存消耗情况。

#### 3.5实验步骤
#### A.测试Gin直接部署的性能

**1）启动Gin服务**

```
cd ~/go/mms
go run main.go
```

##### 2）压测并记录数据

* 使用 `wrk` 进行压测：

  ```
  wrk -t4 -c1000 -d60s --latency http://192.168.220.129:8080/api > gin_result.txt

##### 3）监控资源占用

* ##### **实时监控：**

  ```
  htop -p $(pgrep -f "main.go")
  ```

* **历史数据记录**：

  ```
  nmon -f -s5 -c120  # 每 5 秒记录一次，持续 10 分钟
  ```

* `nmon analyzer`分析数据
  * 下载`nmon analyzer`
  * 导入`nmon`文件
  * 分析内存占用情况

#### B. 测试Nginx部署的性能

**1) 启动Gin服务**

```
cd ~/go/mms
sudo systemctl start mms
```

##### **2) 启动 Nginx**

```
sudo systemctl start nginx
```

**3）压测并记录数据**

* 使用 `wrk` 进行压测：

  ```
  wrk -t4 -c1000 -d60s --latency http://192.168.220.129/api > nginx_result.txt
  ```

**4）监控资源占用**

* **实时监控**：

  ```
  htop 
  ```

* **历史数据记录**：

  ```
  nmon -f -s5 -c120
  ```

#### C. 结果比较

**1）并发连接能力测试**：图一为Gin直接部署，图二为Nginx部署

​	![image-20250223183649619](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223183649619.png)

![image-20250223183625671](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223183625671.png)

| 指标         | Gin 直接部署   | Nginx 代理    |
| ------------ | -------------- | ------------- |
| **QPS**      | 133799.08次/秒 | 53356.21次/秒 |
| **平均延迟** | 9.40ms         | 18.43ms       |
| **P99 延迟** | 42.25ms        | 27.66ms       |
| **错误量**   | 133799.08次    | 53356.21次    |

**2）内存消耗测试**：

图一和图二为`nmon analyzer`分析Gin直接部署的内存情况，

图三和图四为`nmon analyzer`分析通过Nginx部署的内存情况。

![image-20250223184124776](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223184124776.png)

![image-20250223184148427](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223184148427.png)

![image-20250223184239293](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223184239293.png)

![image-20250223184303152](https://raw.githubusercontent.com/ZhouQuan-7237/image-bed/main/image-20250223184303152.png)

| 指标             | Gin 直接部署 | Nginx 代理 |
| ---------------- | ------------ | ---------- |
| **总内存**       | 5.74G        | 5.74G      |
| **最大空闲内存** | 2.59G        | 1.92G      |
| **最小空闲内存** | 2.23G        | 1.19G      |
| **内存消耗**     | 0.36G        | 0.73G      |
| **内存消耗占比** | 6.27%        | 12.72%     |



#### D. 得出结论

| 指标             | Gin 直接部署   | Nginx 代理    |
| ---------------- | -------------- | ------------- |
| **QPS**          | 133799.08次/秒 | 53356.21次/秒 |
| **平均延迟**     | 9.40ms         | 18.43ms       |
| **P99 延迟**     | 42.25ms        | 27.66ms       |
| **错误量**       | 133799.08次    | 53356.21次    |
| **内存消耗占比** | 6.27%          | 12.72%        |



从本次实验来看，Gin 直接暴露后端接口的性能似乎优于通过 Nginx 代理的性能。

然而，由于实验中存在以下问题，我暂时无法得出明确的结论：

1. 实验次数不足：本次实验仅进行了一次测试，可能存在偶然误差。

2. Nginx 配置和 wrk 压测参数设置不合理：
   - Nginx 的配置可能未优化，导致其性能未能充分发挥。
   - wrk 压测时的参数设置可能也不合理，限制了 Nginx 的性能表现。

3. 测试环境不纯净：在进行实验时，测试环境可能受到后台其他应用的影响，导致测试结果不准确。

4. 操作流程不熟悉：由于这是初次进行实验，操作流程可能不够熟悉，导致操作方法不正确。





从本次实验来看，Gin 直接暴露后端接口的性能似乎优于通过Nginx代理的性能，

但并不能据此得出结论，因为实验存在以下问题：

1. 实验次数不够多，存在偶然误差

2. Nginx 配置和 wrk 压测时的参数设置不合理，限制了Nginx的性能发挥
3. 在进行实验时，自己没有创建一个纯净的测试环境，可能受到后台其他应用的影响
4. 自己初次进行实验，操作流程不熟悉，操作方法可能不正确

所以本次实验暂时无法得出结论。



接下来，我计划做出以下改进：

1. 增加实验次数，进行多次重复测试。

2. 优化 Nginx 配置和 wrk 压测参数。

3. 创建纯净的测试环境，减少后台应用的干扰。

4. 熟悉操作流程，确保实验操作的准确性。



希望据此能更准确地评估 Gin 直接部署后端接口与通过 Nginx 代理的性能差异。

